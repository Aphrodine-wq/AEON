name: AEON Formal Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Analysis profile'
        required: false
        default: 'daily'
        type: choice
        options:
        - quick
        - daily
        - security
        - performance
        - safety
      deep_verify:
        description: 'Run deep verification (all 15 engines)'
        required: false
        default: false
        type: boolean

env:
  AEON_CACHE_DIR: .aeon-cache
  PYTHON_VERSION: '3.11'

jobs:
  verification:
    name: Formal Verification
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        profile: [quick, daily, security]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Cache AEON installation
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/pip
          ~/.cache/pip
          ${{ env.AEON_CACHE_DIR }}
        key: ${{ runner.os }}-aeon-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-aeon-
    
    - name: Install AEON
      run: |
        pip install --upgrade pip
        pip install ".[full]"
        aeon --version
    
    - name: Cache verification results
      uses: actions/cache@v4
      with:
        path: ${{ env.AEON_CACHE_DIR }}
        key: ${{ runner.os }}-verify-${{ github.sha }}-${{ matrix.profile }}
        restore-keys: |
          ${{ runner.os }}-verify-${{ github.sha }}-
          ${{ runner.os }}-verify-
    
    - name: Run verification
      run: |
        echo "üîç Running AEON verification with profile: ${{ matrix.profile }}"
        
        if [ "${{ matrix.profile }}" = "security" ]; then
          aeon scan . --profile security --parallel --format sarif --output security-results.sarif
        elif [ "${{ matrix.profile }}" = "performance" ]; then
          aeon scan . --profile performance --parallel --format json --output performance-results.json
        else
          aeon scan . --profile ${{ matrix.profile }} --parallel --format markdown --output verification-results.md
        fi
        
        # Generate detailed report
        aeon scan . --deep-verify --format json --output detailed-report.json
    
    - name: Upload SARIF results
      if: matrix.profile == 'security'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: security-results.sarif
    
    - name: Upload verification results
      uses: actions/upload-artifact@v4
      with:
        name: verification-results-${{ matrix.profile }}
        path: |
          verification-results.md
          security-results.sarif
          performance-results.json
          detailed-report.json
        retention-days: 30
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const results = fs.readFileSync('verification-results.md', 'utf8');
            const comment = `## ü§ñ AEON Formal Verification Results (${{ matrix.profile }} profile)\n\n${results}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read results file:', error);
          }
    
    - name: Check verification status
      run: |
        if [ -f detailed-report.json ]; then
          errors=$(jq -r '.total_errors' detailed-report.json)
          if [ "$errors" -gt 0 ]; then
            echo "‚ùå Verification failed with $errors errors"
            exit 1
          else
            echo "‚úÖ All files verified successfully"
          fi
        fi

  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: verification
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install AEON
      run: |
        pip install ".[full]"
    
    - name: Run security analysis
      run: |
        echo "üîí Running comprehensive security analysis..."
        
        # Taint analysis
        aeon scan . --analyses taint --format json --output taint-analysis.json
        
        # Information flow analysis
        aeon scan . --analyses info-flow --format json --output infoflow-analysis.json
        
        # Concurrency analysis
        aeon scan . --analyses concurrency --format json --output concurrency-analysis.json
        
        # Generate security report
        aeon scan . --profile security --format markdown --output security-report.md
    
    - name: Upload security results
      uses: actions/upload-artifact@v4
      with:
        name: security-analysis
        path: |
          taint-analysis.json
          infoflow-analysis.json
          concurrency-analysis.json
          security-report.md
        retention-days: 90

  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: verification
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install AEON
      run: |
        pip install ".[full]"
    
    - name: Run performance analysis
      run: |
        echo "‚ö° Running performance analysis..."
        
        # Complexity analysis
        aeon scan . --analyses complexity --format json --output complexity-analysis.json
        
        # Termination analysis
        aeon scan . --analyses termination --format json --output termination-analysis.json
        
        # Memory analysis
        aeon scan . --analyses memory --format json --output memory-analysis.json
        
        # Generate performance report
        aeon scan . --profile performance --format markdown --output performance-report.md
    
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-analysis
        path: |
          complexity-analysis.json
          termination-analysis.json
          memory-analysis.json
          performance-report.md
        retention-days: 90

  compliance-report:
    name: Compliance Report
    runs-on: ubuntu-latest
    needs: [verification, security-scan, performance-analysis]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate compliance report
      run: |
        echo "üìä Generating comprehensive compliance report..."
        
        # Create combined report
        cat > compliance-report.md << 'EOF'
        # AEON Compliance Report
        
        ## Executive Summary
        
        This report provides a comprehensive analysis of the codebase using AEON's formal verification engines.
        
        EOF
        
        # Add verification results
        if [ -f verification-results-daily/verification-results.md ]; then
          echo "## Verification Results" >> compliance-report.md
          cat verification-results-daily/verification-results.md >> compliance-report.md
        fi
        
        # Add security analysis
        if [ -f security-analysis/security-report.md ]; then
          echo "## Security Analysis" >> compliance-report.md
          cat security-analysis/security-report.md >> compliance-report.md
        fi
        
        # Add performance analysis
        if [ -f performance-analysis/performance-report.md ]; then
          echo "## Performance Analysis" >> compliance-report.md
          cat performance-analysis/performance-report.md >> compliance-report.md
        fi
        
        # Add timestamp and metadata
        echo "" >> compliance-report.md
        echo "---" >> compliance-report.md
        echo "**Generated:** $(date -u)" >> compliance-report.md
        echo "**Commit:** ${{ github.sha }}" >> compliance-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> compliance-report.md
    
    - name: Upload compliance report
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: compliance-report.md
        retention-days: 365
    
    - name: Create release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          compliance-report.md
          verification-results-*/
          security-analysis/
          performance-analysis/
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [verification, security-scan, performance-analysis]
    if: always()
    
    steps:
    - name: Download verification results
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: verification-results-daily
    
    - name: Send notification
      if: needs.verification.result == 'failure' || needs.security-scan.result == 'failure' || needs.performance-analysis.result == 'failure'
      run: |
        echo "‚ùå AEON verification failed"
        echo "Check the workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        # Here you could add Slack, Teams, or email notifications
    
    - name: Success notification
      if: success()
      run: |
        echo "‚úÖ AEON verification completed successfully"
        # Here you could add success notifications
